

# Todo 应用 Helm Chart 部署与 CI/CD 实现教程

## 项目概述

本项目是一个已开发完成的 Todo 应用，包含前后端代码，现在需要将其打包为 Helm Chart 并部署到 Kubernetes 集群，同时实现 CI/CD 自动化流程。

## 创建 Helm Chart

### 初始化 Chart

首先，我们需要创建一个名为`todo-chart`的 Helm Chart 目录结构：

```bash
# 进入项目根目录
cd d:\projects\todos-helm

# 创建Helm Chart
helm create todo-chart
```

执行上述命令后，会生成一个标准的 Helm Chart 目录结构，包含以下主要文件和目录：

```
todo-chart/
├── charts/          # 依赖的子 Chart 目录
├── templates/       # Kubernetes 资源模板目录
├── Chart.yaml       # Chart 的元数据信息
├── values.yaml      # Chart 的配置值
└── .helmignore      # Helm 忽略文件
```

### 清理不必要的文件

默认生成的 Chart 包含一些我们不需要的文件，需要进行清理：

1. 删除`templates`目录下的默认文件：

```bash
rm todo-chart/templates/*
```

2. 保留并修改以下必要文件：
   - `Chart.yaml`：Chart 元数据
   - `values.yaml`：配置值
   - `templates/`：我们将创建自己的模板文件

## 完善 Chart 配置文件

### 修改 Chart.yaml

编辑`todo-chart/Chart.yaml`文件，填写 Chart 的元数据信息：

```yaml
apiVersion: v2
name: todo-chart
description: A Helm chart for Todo application
version: 0.1.0
type: application
appVersion: "1.0.0"
```

### 创建 values.yaml

编辑`todo-chart/values.yaml`文件，配置应用的基本参数：

```yaml
# 全局配置
global:
  namespace: default

# MySQL配置
mysql:
  image: mysql
  tag: 8.0
  imagePullPolicy: IfNotPresent
  rootPassword: "123456"
  database: todo_db
  user: jerry
  password: "000000"
  persistence:
    enabled: true
    size: 1Gi
  service:
    type: ClusterIP
    port: 3306

# Backend配置
backend:
  replicaCount: 1
  image:
    repository: todo-backend
    tag: latest
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    port: 5000
  env:
    SECRET_KEY: your_secret_key_here
    MYSQL_USER: jerry
    MYSQL_PASSWORD: "000000"
    MYSQL_DATABASE: todo_db
    MYSQL_HOST: todo-chart-mysql

# Frontend配置
frontend:
  replicaCount: 1
  image:
    repository: todo-frontend
    tag: latest
    pullPolicy: IfNotPresent
  service:
    type: NodePort
    port: 80
    nodePort: 30080

```

### 创建辅助模板文件

在`templates`目录下创建`_helpers.tpl`文件，定义一些可复用的模板函数：

```yaml
{{/*
Expand the name of the chart.
*/}}
{{- define "todo-chart.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a default fully qualified app name.
We truncate at 63 chars because some Kubernetes name fields are limited to this (by the DNS naming spec).
If release name contains chart name it will be used as a full name.
*/}}
{{- define "todo-chart.fullname" -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- $name := default .Chart.Name .Values.nameOverride }}
{{- if contains $name .Release.Name }}
{{- .Release.Name | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" }}
{{- end }}
{{- end }}
{{- end }}

{{/*
Create chart name and version as used by the chart label.
*/}}
{{- define "todo-chart.chart" -}}
{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Common labels
*/}}
{{- define "todo-chart.labels" -}}
helm.sh/chart: {{ include "todo-chart.chart" . }}
{{ include "todo-chart.selectorLabels" . }}
{{- if .Chart.AppVersion }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
{{- end }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{/*
Selector labels
*/}}
{{- define "todo-chart.selectorLabels" -}}
app.kubernetes.io/name: {{ include "todo-chart.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

{{/*
MySQL specific labels
*/}}
{{- define "todo-chart.mysql.labels" -}}
{{- include "todo-chart.labels" . }}
app.kubernetes.io/component: mysql
{{- end }}

{{/*
MySQL specific selector labels
*/}}
{{- define "todo-chart.mysql.selectorLabels" -}}
{{- include "todo-chart.selectorLabels" . }}
app.kubernetes.io/component: mysql
{{- end }}

{{/*
Backend specific labels
*/}}
{{- define "todo-chart.backend.labels" -}}
{{- include "todo-chart.labels" . }}
app.kubernetes.io/component: backend
{{- end }}

{{/*
Backend specific selector labels
*/}}
{{- define "todo-chart.backend.selectorLabels" -}}
{{- include "todo-chart.selectorLabels" . }}
app.kubernetes.io/component: backend
{{- end }}

{{/*
Frontend specific labels
*/}}
{{- define "todo-chart.frontend.labels" -}}
{{- include "todo-chart.labels" . }}
app.kubernetes.io/component: frontend
{{- end }}

{{/*
Frontend specific selector labels
*/}}
{{- define "todo-chart.frontend.selectorLabels" -}}
{{- include "todo-chart.selectorLabels" . }}
app.kubernetes.io/component: frontend
{{- end }}
```

### 创建 MySQL 配置文件

在`templates`目录下创建`mysql.yaml`文件，定义 MySQL 的 Deployment、Service 和 PersistentVolumeClaim：

```yaml
# MySQL Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: { { include "todo-chart.mysql.fullname" . } }
  labels: { { - include "todo-chart.mysql.labels" . } }
spec:
  replicas: 1
  selector:
    matchLabels: { { - include "todo-chart.mysql.selectorLabels" . } }
  template:
    metadata:
      labels: { { - include "todo-chart.mysql.selectorLabels" . } }
    spec:
      containers:
        - name: mysql
          image: "{{ .Values.mysql.image }}:{{ .Values.mysql.tag | default .Chart.AppVersion }}"
          imagePullPolicy: { { .Values.mysql.imagePullPolicy } }
          env:
            - name: MYSQL_ROOT_PASSWORD
              value: { { .Values.mysql.rootPassword | quote } }
            - name: MYSQL_DATABASE
              value: { { .Values.mysql.database | quote } }
            - name: MYSQL_USER
              value: { { .Values.mysql.user | quote } }
            - name: MYSQL_PASSWORD
              value: { { .Values.mysql.password | quote } }
          ports:
            - containerPort: 3306
              name: mysql
          volumeMounts:
            - name: mysql-data
              mountPath: /var/lib/mysql
      volumes:
        - name: mysql-data
          persistentVolumeClaim:
            claimName: { { include "todo-chart.mysql.fullname" . } }
---
# MySQL Service
apiVersion: v1
kind: Service
metadata:
  name: { { include "todo-chart.mysql.fullname" . } }
  labels: { { - include "todo-chart.mysql.labels" . } }
spec:
  type: { { .Values.mysql.service.type } }
  ports:
    - port: { { .Values.mysql.service.port } }
      targetPort: mysql
      protocol: TCP
      name: mysql
  selector: { { - include "todo-chart.mysql.selectorLabels" . } }
---
# MySQL PersistentVolumeClaim
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: { { include "todo-chart.mysql.fullname" . } }
  labels: { { - include "todo-chart.mysql.labels" . } }
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: { { .Values.mysql.persistence.size } }
```

### 创建 Backend 配置文件

在`templates`目录下创建`backend.yaml`文件，定义 Backend 的 Deployment 和 Service：

```yaml
# Backend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: { { include "todo-chart.backend.fullname" . } }
  labels: { { - include "todo-chart.backend.labels" . } }
spec:
  replicas: { { .Values.backend.replicaCount } }
  selector:
    matchLabels: { { - include "todo-chart.backend.selectorLabels" . } }
  template:
    metadata:
      labels: { { - include "todo-chart.backend.selectorLabels" . } }
    spec:
      containers:
        - name: backend
          image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag }}"
          imagePullPolicy: { { .Values.backend.imagePullPolicy } }
          env:
            - name: SECRET_KEY
              value: { { .Values.backend.env.SECRET_KEY | quote } }
            - name: MYSQL_USER
              value: { { .Values.backend.env.MYSQL_USER | quote } }
            - name: MYSQL_PASSWORD
              value: { { .Values.backend.env.MYSQL_PASSWORD | quote } }
            - name: MYSQL_DATABASE
              value: { { .Values.backend.env.MYSQL_DATABASE | quote } }
            - name: MYSQL_HOST
              value: { { .Values.backend.env.MYSQL_HOST | quote } }
          ports:
            - containerPort: 5000
              name: backend
---
# Backend Service
apiVersion: v1
kind: Service
metadata:
  name: { { include "todo-chart.backend.fullname" . } }
  labels: { { - include "todo-chart.backend.labels" . } }
spec:
  type: { { .Values.backend.service.type } }
  ports:
    - port: { { .Values.backend.service.port } }
      targetPort: backend
      protocol: TCP
      name: backend
  selector: { { - include "todo-chart.backend.selectorLabels" . } }
```

### 创建 Frontend 配置文件

在`templates`目录下创建`frontend.yaml`文件，定义 Frontend 的 Deployment 和 Service：

```yaml
# Frontend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: { { include "todo-chart.frontend.fullname" . } }
  labels: { { - include "todo-chart.frontend.labels" . } }
spec:
  replicas: { { .Values.frontend.replicaCount } }
  selector:
    matchLabels: { { - include "todo-chart.frontend.selectorLabels" . } }
  template:
    metadata:
      labels: { { - include "todo-chart.frontend.selectorLabels" . } }
    spec:
      containers:
        - name: frontend
          image: "{{ .Values.frontend.image.repository }}:{{ .Values.frontend.image.tag }}"
          imagePullPolicy: { { .Values.frontend.imagePullPolicy } }
          ports:
            - containerPort: 80
              name: frontend
---
# Frontend Service
apiVersion: v1
kind: Service
metadata:
  name: { { include "todo-chart.frontend.fullname" . } }
  labels: { { - include "todo-chart.frontend.labels" . } }
spec:
  type: { { .Values.frontend.service.type } }
  ports:
    - port: { { .Values.frontend.service.port } }
      targetPort: frontend
      protocol: TCP
      name: frontend
      nodePort: { { .Values.frontend.service.nodePort } }
  selector: { { - include "todo-chart.frontend.selectorLabels" . } }
```

## 使用 GitLab CI 构建镜像（推荐）
## 本地部署测试

### 启动 Minikube

首先，确保 Minikube 已经启动：

```bash
# 启动 Minikube
minikube start

# 检查 Minikube 状态
minikube status
```

### 准备 Docker 镜像

#### 方式一：使用 GitLab CI 构建的镜像（推荐）

如果已经通过 GitLab CI 构建了镜像，可以直接拉取这些镜像：

```bash
# 拉取后端镜像
docker pull <your-docker-hub-username>/todos-helm-backend:latest  

# 拉取前端镜像
docker pull <your-docker-hub-username>/todos-helm-frontend:latest 

# 将镜像加载到 Minikube 中
minikube image load <your-docker-hub-username>/todos-helm-backend:latest todo-backend:latest       
minikube image load <your-docker-hub-username>/todos-helm-frontend:latest todo-frontend:latest     
```

#### 方式二：本地手动构建镜像    

如果需要快速本地测试，也可以手动构建镜像：

```bash
# 构建Backend镜像
docker build -t todo-backend:latest ./backend

# 构建Frontend镜像
docker build -t todo-frontend:latest ./frontend

# 将镜像加载到Minikube中
minikube image load todo-backend:latest
minikube image load todo-frontend:latest
```

### 安装 Helm Chart

```bash
cd /d/projects/todos-helm
helm install todo-app ./todo-chart
```

### 查看部署状态

```bash
# 查看所有资源
kubectl get all -l app.kubernetes.io/instance=todo-app

# 查看 Pod 状态（等待所有 Pod 就绪）
kubectl get pods -w -l app.kubernetes.io/instance=todo-app

# 查看服务状态
kubectl get services -l app.kubernetes.io/instance=todo-app
```

### 访问应用

使用端口转发访问应用：

```bash
# 转发前端服务端口
kubectl port-forward service/todo-chart-frontend 8080:80

# 转发后端服务端口（可选）
kubectl port-forward service/todo-chart-backend 5000:5000
```

然后在浏览器中访问 `http://localhost:8080` 即可使用应用。

**原因说明**：

- 端口转发是开发环境中常用的访问方式
- 生产环境建议使用 Ingress 或 LoadBalancer 服务类型

## 更新应用

当您修改了应用代码或配置后，可以使用 Helm 更新部署：

```bash
# 更新 Chart
helm upgrade todo-app ./todo-chart

# 或使用新版本的镜像
helm upgrade todo-app ./todo-chart --set backend.image.tag=new-version,frontend.image.tag=new-version
```

**原因说明**：

- Helm 支持滚动更新，确保零停机部署
- 可以通过 `--set` 参数动态修改配置

## 卸载应用

如果需要卸载应用，可以使用以下命令：

```bash
# 卸载 Chart
helm uninstall todo-app

# 删除持久化数据（可选）
kubectl delete pvc todo-chart-mysql
```

**原因说明**：

- 卸载 Chart 会删除所有相关资源
- 持久化存储需要手动删除，以防止数据意外丢失

## 总结

通过以上步骤，您已经成功创建了一个完整的 Helm Chart 来部署您的 TODO 应用。这个 Chart 包含了：

1. MySQL 数据库的部署和持久化
2. Flask 后端服务的部署和配置
3. React 前端服务的部署和配置

使用 Helm 可以让您更轻松地管理应用的部署、升级和回滚，提高开发和运维效率。在生产环境中，建议：

1. 使用 Secret 存储敏感信息（如数据库密码、密钥等）
2. 配置 Ingress 实现域名访问
3. 启用资源限制和请求，确保集群稳定性
4. 配置 HorizontalPodAutoscaler 实现自动扩缩容

希望这份指南对您有所帮助！如果您有任何问题或需要进一步的指导，请随时告诉我。
