# 使用 Helm 部署 Todos 应用详细指南

## 项目架构概述

您的 TODO 应用是一个典型的三层架构应用：

- **前端**：基于 React + Vite 的单页应用，使用 Nginx 提供服务
- **后端**：基于 Flask 的 RESTful API 服务
- **数据库**：MySQL 数据库用于存储 TODO 数据

使用 Helm 可以将这三个组件作为一个整体部署到 Kubernetes 集群中，实现统一管理和版本控制。

## 创建 Helm Chart

首先，我们需要创建一个 Helm Chart 来管理我们的应用部署。在项目根目录下执行以下命令：

```cmd
cd d:\projects\todos-helm
helm create todo-chart
```

这条命令会创建一个名为 `todo-chart` 的目录，其中包含了 Helm Chart 的基本结构和配置文件。

## Helm Chart 结构说明

在 `todo-chart/` 目录下，您可以看到以下完整的目录结构：

```
todos-helm/
 │
 ├── todo-chart/                # Helm Chart 目录
 │   ├── Chart.yaml             # Chart 基本信息配置（名称、版本等）
 │   ├── values.yaml            # 部署参数配置（镜像、端口、环境变量等）
 │   ├── .helmignore            # 忽略不需要打包的文件
 │   ├── charts/                # 子 Chart 目录
 │   └── templates/             # Kubernetes 资源模板文件
 │       ├── NOTES.txt          # 部署成功后的提示信息
 │       ├── _helpers.tpl       # 模板函数定义
 │       ├── mysql.yaml         # MySQL 组件的完整配置（Deployment+Service+PVC）
 │       ├── backend.yaml       # 后端服务配置（Deployment+Service）
 │       ├── frontend.yaml      # 前端服务配置（Deployment+Service）
 │       ├── hpa.yaml           # 水平自动扩缩容配置（可选）
 │       ├── httproute.yaml     # HTTP 路由配置（可选）
 │       ├── ingress.yaml       # Ingress 配置（可选）
 │       ├── serviceaccount.yaml  # 服务账号配置（可选）
 │       └── tests/             # 测试文件目录
 │           └── test-connection.yaml  # 连接测试

```

各核心文件的作用说明：

| 文件/目录   | 作用                                   |
| ----------- | -------------------------------------- |
| Chart.yaml  | Chart 基本信息配置（名称、版本等）     |
| values.yaml | 部署参数配置（镜像、端口、环境变量等） |
| templates/  | Kubernetes 资源模板文件                |
| .helmignore | 忽略不需要打包的文件                   |

## 配置步骤

### 修改 Chart.yaml（可选）

```yaml d:\projects\todos-helm\todo-chart\Chart.yaml
apiVersion: v2
name: todo-chart
description: A Helm chart for deploying Todo application (Frontend + Backend + MySQL)
version: 0.1.0
appVersion: 1.0.0
```

这是 Chart 的元数据配置，主要用于标识 Chart 的基本信息。

### 更新 values.yaml 配置

```yaml d:\projects\todos-helm\todo-chart\values.yaml
# 默认值配置
replicaCount: 1

# 数据库配置 - MySQL
mysql:
  enabled: true
  image: mysql:8.0
  imagePullPolicy: IfNotPresent
  rootPassword: "your-root-password"    # 生产环境建议使用 Secret
  database: "todos_db"
  user: "todo_user"
  password: "your-todo-password"        # 生产环境建议使用 Secret
  persistence:
    enabled: true
    size: 1Gi
  service:
    port: 3306

# 后端服务配置 - Flask API
backend:
  replicaCount: 1
  image:
    repository: "jerrybaijy/todos-helm-backend"  # 从.gitlab-ci.yml中获取的镜像名称
    tag: "latest"
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    port: 5000
  env:
    SECRET_KEY: "your-secret-key"       # 生产环境建议使用 Secret
    MYSQL_USER: "{{ .Values.mysql.user }}"
    MYSQL_PASSWORD: "{{ .Values.mysql.password }}"
    DB_HOST: "{{ include "todo-chart.mysql.fullname" . }}"
    MYSQL_DATABASE: "{{ .Values.mysql.database }}"
    FLASK_APP: "run.py"
    FLASK_ENV: "production"

# 前端服务配置 - React + Nginx
frontend:
  replicaCount: 1
  image:
    repository: "jerrybaijy/todos-helm-frontend"  # 从.gitlab-ci.yml中获取的镜像名称
    tag: "latest"
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    port: 80
  ingress:
    enabled: false
    # 生产环境可配置 ingress
```

**原因说明**：

- 分离三个组件的配置，使结构更清晰
- 使用模板语法引用共享配置（如数据库用户名密码）
- 预留了生产环境优化空间（如使用 Secret 存储敏感信息）

### 创建 MySQL 模板文件

创建 `todo-chart/templates/mysql.yaml`：

```yaml d:\projects\todos-helm\todo-chart\templates\mysql.yaml
# MySQL Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: { { include "todo-chart.mysql.fullname" . } }
  labels: { { - include "todo-chart.mysql.labels" . | nindent 4 } }
spec:
  replicas: 1
  selector:
    matchLabels:
      { { - include "todo-chart.mysql.selectorLabels" . | nindent 6 } }
  template:
    metadata:
      labels: { { - include "todo-chart.mysql.selectorLabels" . | nindent 8 } }
    spec:
      containers:
        - name: mysql
          image: "{{ .Values.mysql.image }}:{{ .Values.mysql.tag | default .Chart.AppVersion }}"
          imagePullPolicy: { { .Values.mysql.imagePullPolicy } }
          env:
            - name: MYSQL_ROOT_PASSWORD
              value: { { .Values.mysql.rootPassword | quote } }
            - name: MYSQL_DATABASE
              value: { { .Values.mysql.database | quote } }
            - name: MYSQL_USER
              value: { { .Values.mysql.user | quote } }
            - name: MYSQL_PASSWORD
              value: { { .Values.mysql.password | quote } }
          ports:
            - containerPort: 3306
              name: mysql
          volumeMounts:
            - name: mysql-data
              mountPath: /var/lib/mysql
          livenessProbe:
            exec:
              command: ["mysqladmin", "ping"]
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
      volumes:
        - name: mysql-data
          persistentVolumeClaim:
            claimName: { { include "todo-chart.mysql.fullname" . } }
---
# MySQL Service
apiVersion: v1
kind: Service
metadata:
  name: { { include "todo-chart.mysql.fullname" . } }
  labels: { { - include "todo-chart.mysql.labels" . | nindent 4 } }
spec:
  type: ClusterIP
  ports:
    - port: { { .Values.mysql.service.port } }
      targetPort: mysql
      name: mysql
  selector: { { - include "todo-chart.mysql.selectorLabels" . | nindent 4 } }
---
# MySQL PersistentVolumeClaim
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: { { include "todo-chart.mysql.fullname" . } }
  labels: { { - include "todo-chart.mysql.labels" . | nindent 4 } }
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: { { .Values.mysql.persistence.size } }
```

**原因说明**：

- 为 MySQL 创建完整的部署配置，包括 Deployment、Service 和 PersistentVolumeClaim
- Deployment 确保数据库实例的运行和健康检查
- Service 提供集群内部访问数据库的方式
- PersistentVolumeClaim 确保数据库数据在 Pod 重启后不会丢失
- 统一管理 MySQL 相关的所有 Kubernetes 资源，提高维护性

### 创建后端模板文件

创建 `todo-chart/templates/backend.yaml`：

```yaml d:\projects\todos-helm\todo-chart\templates\backend.yaml
# Backend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "todo-chart.backend.fullname" . }}
  labels:
    {{- include "todo-chart.backend.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.backend.replicaCount }}
  selector:
    matchLabels:
      {{- include "todo-chart.backend.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "todo-chart.backend.selectorLabels" . | nindent 8 }}
    spec:
      containers:
        - name: backend
          image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.backend.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.backend.service.port }}
              name: backend
          env:
            {{- range $key, $value := .Values.backend.env }}
            - name: {{ $key }}
              value: {{ $value | quote }}
            {{- end }}
          livenessProbe:
            httpGet:
              path: /api/todos
              port: backend
            initialDelaySeconds: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/todos
              port: backend
            initialDelaySeconds: 30
            periodSeconds: 5
---
# Backend Service
apiVersion: v1
kind: Service
metadata:
  name: { { include "todo-chart.backend.fullname" . } }
  labels: { { - include "todo-chart.backend.labels" . | nindent 4 } }
spec:
  type: { { .Values.backend.service.type } }
  ports:
    - port: { { .Values.backend.service.port } }
      targetPort: backend
      name: backend
  selector: { { - include "todo-chart.backend.selectorLabels" . | nindent 4 } }
```

**原因说明**：

- 部署 Flask 后端服务，配置环境变量连接到 MySQL 数据库
- 添加健康检查，确保服务正常运行
- 为后端服务创建 ClusterIP 类型的服务，允许前端服务通过 Kubernetes DNS 访问后端 API
- 统一管理后端相关的所有 Kubernetes 资源，提高维护性

### 创建前端模板文件

创建 `todo-chart/templates/frontend.yaml`：

```yaml d:\projects\todos-helm\todo-chart\templates\frontend.yaml
# Frontend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: { { include "todo-chart.frontend.fullname" . } }
  labels: { { - include "todo-chart.frontend.labels" . | nindent 4 } }
spec:
  replicas: { { .Values.frontend.replicaCount } }
  selector:
    matchLabels:
      { { - include "todo-chart.frontend.selectorLabels" . | nindent 6 } }
  template:
    metadata:
      labels:
        { { - include "todo-chart.frontend.selectorLabels" . | nindent 8 } }
    spec:
      containers:
        - name: frontend
          image: "{{ .Values.frontend.image.repository }}:{{ .Values.frontend.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: { { .Values.frontend.image.pullPolicy } }
          ports:
            - containerPort: { { .Values.frontend.service.port } }
              name: frontend
          livenessProbe:
            httpGet:
              path: /
              port: frontend
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: frontend
            initialDelaySeconds: 10
            periodSeconds: 5
---
# Frontend Service
apiVersion: v1
kind: Service
metadata:
  name: { { include "todo-chart.frontend.fullname" . } }
  labels: { { - include "todo-chart.frontend.labels" . | nindent 4 } }
spec:
  type: { { .Values.frontend.service.type } }
  ports:
    - port: { { .Values.frontend.service.port } }
      targetPort: frontend
      name: frontend
  selector: { { - include "todo-chart.frontend.selectorLabels" . | nindent 4 } }
```

**原因说明**：

- 部署 React 前端服务，使用 Nginx 作为静态文件服务器
- 添加健康检查，确保服务正常运行
- 为前端服务创建 ClusterIP 类型的服务，作为 Ingress 的后端服务
- 统一管理前端相关的所有 Kubernetes 资源，提高维护性

### 更新 \_helpers.tpl 模板函数

**注意：不是替换原文件内容，而是将以下内容添加到 `todo-chart/templates/_helpers.tpl` 文件的末尾**，添加三个组件的模板函数：

```yaml d:\projects\todos-helm\todo-chart\templates_helpers.tpl
{{/* 生成 MySQL 资源的完整名称 */}}
{{- define "todo-chart.mysql.fullname" -}}
{{- .Release.Name }}-mysql
{{- end -}}

{{/* 生成 MySQL 资源的标签 */}}
{{- define "todo-chart.mysql.labels" -}}
{{- include "todo-chart.labels" . | nindent 4 }}
app.kubernetes.io/component: mysql
{{- end -}}

{{/* 生成 MySQL 资源的选择器标签 */}}
{{- define "todo-chart.mysql.selectorLabels" -}}
{{- include "todo-chart.selectorLabels" . | nindent 4 }}
app.kubernetes.io/component: mysql
{{- end -}}

{{/* 生成后端服务资源的完整名称 */}}
{{- define "todo-chart.backend.fullname" -}}
{{- .Release.Name }}-backend
{{- end -}}

{{/* 生成后端服务资源的标签 */}}
{{- define "todo-chart.backend.labels" -}}
{{- include "todo-chart.labels" . | nindent 4 }}
app.kubernetes.io/component: backend
{{- end -}}

{{/* 生成后端服务资源的选择器标签 */}}
{{- define "todo-chart.backend.selectorLabels" -}}
{{- include "todo-chart.selectorLabels" . | nindent 4 }}
app.kubernetes.io/component: backend
{{- end -}}

{{/* 生成前端服务资源的完整名称 */}}
{{- define "todo-chart.frontend.fullname" -}}
{{- .Release.Name }}-frontend
{{- end -}}

{{/* 生成前端服务资源的标签 */}}
{{- define "todo-chart.frontend.labels" -}}
{{- include "todo-chart.labels" . | nindent 4 }}
app.kubernetes.io/component: frontend
{{- end -}}

{{/* 生成前端服务资源的选择器标签 */}}
{{- define "todo-chart.frontend.selectorLabels" -}}
{{- include "todo-chart.selectorLabels" . | nindent 4 }}
app.kubernetes.io/component: frontend
{{- end -}}
```

**原因说明**：

- 添加三个组件的模板函数，用于生成一致的资源名称和标签
- 保持 Helm Chart 的一致性和可维护性

### 删除默认模板文件

由于我们已经为每个组件创建了独立的模板文件，需要删除默认的模板文件：

```cmd
del /Q d:\projects\todos-helm\todo-chart\templates\deployment.yaml
del /Q d:\projects\todos-helm\todo-chart\templates\service.yaml
```

**原因说明**：

- 默认模板是为单一应用设计的，不适合我们的多组件架构
- 删除默认模板可以避免冲突和混淆

## 镜像信息说明

根据项目中的 `.gitlab-ci.yml` 文件，镜像已经通过 CI/CD 流程构建并推送到 Docker Hub。镜像名称为：

- 后端镜像：`jerrybaijy/todos-helm-backend:latest`
- 前端镜像：`jerrybaijy/todos-helm-frontend:latest`

这些镜像名称已在 `values.yaml` 中配置好，无需手动构建和推送。

## 部署应用

### 安装 Helm Chart

```cmd
cd d:\projects\todos-helm
helm install todo-app ./todo-chart
```

### 查看部署状态

```cmd
# 查看所有资源
kubectl get all -l app.kubernetes.io/instance=todo-app

# 查看 Pod 状态
kubectl get pods -l app.kubernetes.io/instance=todo-app

# 查看服务状态
kubectl get services -l app.kubernetes.io/instance=todo-app
```

### 访问应用

如果您在本地 Kubernetes 环境（如 Minikube）中部署，可以使用端口转发访问应用：

```cmd
# 转发前端服务端口
kubectl port-forward service/todo-app-frontend 8080:80

# 转发后端服务端口（可选）
kubectl port-forward service/todo-app-backend 5000:5000
```

然后在浏览器中访问 `http://localhost:8080` 即可使用应用。

**原因说明**：

- 端口转发是开发环境中常用的访问方式
- 生产环境建议使用 Ingress 或 LoadBalancer 服务类型

## 更新应用

当您修改了应用代码或配置后，可以使用 Helm 更新部署：

```cmd
# 更新 Chart
helm upgrade todo-app ./todo-chart

# 或使用新版本的镜像
helm upgrade todo-app ./todo-chart --set backend.image.tag=new-version,frontend.image.tag=new-version
```

**原因说明**：

- Helm 支持滚动更新，确保零停机部署
- 可以通过 `--set` 参数动态修改配置

## 卸载应用

如果需要卸载应用，可以使用以下命令：

```cmd
# 卸载 Chart
helm uninstall todo-app

# 删除持久化数据（可选）
kubectl delete pvc todo-app-mysql
```

**原因说明**：

- 卸载 Chart 会删除所有相关资源
- 持久化存储需要手动删除，以防止数据意外丢失

## 总结

通过以上步骤，您已经成功创建了一个完整的 Helm Chart 来部署您的 TODO 应用。这个 Chart 包含了：

1. MySQL 数据库的部署和持久化
2. Flask 后端服务的部署和配置
3. React 前端服务的部署和配置

使用 Helm 可以让您更轻松地管理应用的部署、升级和回滚，提高开发和运维效率。在生产环境中，建议：

1. 使用 Secret 存储敏感信息（如数据库密码、密钥等）
2. 配置 Ingress 实现域名访问
3. 启用资源限制和请求，确保集群稳定性
4. 配置 HorizontalPodAutoscaler 实现自动扩缩容

希望这份指南对您有所帮助！如果您有任何问题或需要进一步的指导，请随时告诉我。
